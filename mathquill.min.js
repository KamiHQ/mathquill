/**
 * Copyright 2010 Jay and Han (laughinghan@gmail.com)
 * License, Usage and Readme at http://mathquill.com
 *//****************************
 * Important opening stuff.
 ***************************/(function(a){function L(a,b,c){f.apply(this,arguments)}function K(b){this.parent=this.root=b;var c=this.jQ=this._jQ=a('<span class="cursor"></span>');this.blink=function(){c.toggleClass("blink")}}function J(a,b){d.call(this,"\\"+b+" ","<span>"+b+"</span>")}function I(a,b){d.call(this,a,"<big>"+b+"</big>")}function H(a,b){E.apply(this,arguments)}function G(a,b){d.call(this,a,'<span class="binary-operator">'+b+"</span>")}function F(a,b){d.call(this,a,'<span class="nonSymbola">'+(b||a)+"</span>")}function E(a,b){d.call(this,a,"<span>"+(b||a)+"</span>")}function D(a,b){d.call(this,a,"<var>"+(b||a)+"</var>")}function C(a){var b=Array.prototype.slice.call(arguments,1);return m(a,function(){a.apply(this,b)})}function B(a){c.call(this,"\\vector",undefined,a)}function A(){z.apply(this,arguments)}function z(a){c.call(this,"\\binom",undefined,a),this.jQ.wrapInner('<span class="array"></span>').prepend('<span class="paren">(</span>').append('<span class="paren">)</span>')}function y(a){c.call(this,"\\"),a&&(this.replacedFragment=a.detach(),this.isEmpty=function(){return!1})}function x(){}function w(a){a instanceof f?this.replacedText=a.remove().jQ.text():typeof a==="string"&&(this.replacedText=a),c.call(this,"\\text")}function v(a){t.call(this,"|","|",a)}function u(a,b,c){s.call(this,a,b,a,b,c)}function t(a,b,c){r.call(this,a,b,a,b,c)}function s(a,b,c,d,e){r.apply(this,arguments)}function r(a,b,d,e,f){c.call(this,"\\left"+d,['<span><span class="paren">'+a+'</span><span></span><span class="paren">'+b+"</span></span>"],f),this.end="\\right"+e}function q(a){c.call(this,"\\sqrt",undefined,a)}function p(){o.apply(this,arguments)}function o(a){c.call(this,"\\frac",undefined,a),this.jQ.append('<span style="width:0">&nbsp;</span>')}function n(a,b,d){c.call(this,a,[b],d)}function m(a,b){b.prototype=a.prototype;return b}function j(){}function i(a){c.call(this,"$"),this.firstChild.cursor=a,this.firstChild.keypress=function(b){if(this.skipKeypress)return!0;var c=String.fromCharCode(b.which);c==="$"&&a.parent==this?this.isEmpty()?a.insertAfter(this.parent).backspace().insertNew(new E("\\$","$")).show():a.next?a.prev?a.show().write(c):a.insertBefore(this.parent):a.insertAfter(this.parent):a.show().write(c),b.preventDefault();return!0}}function h(){}function g(b,c,d,e){var f=b.contents().detach();d||b.addClass("mathquill-rendered-math"),c.jQ=b.data("[[mathquill internal data]]",{block:c,revert:function(){b.empty().unbind(".mathquill").removeClass("mathquill-rendered-math mathquill-editable mathquill-textbox").append(f)}});var g=c.cursor=new K(c);c.renderLatex(f.text());if(e){c.textarea=a('<span class="textarea"><textarea></textarea></span>').prependTo(b.addClass("mathquill-editable"));var h=c.textarea.children();d&&b.addClass("mathquill-textbox"),h.focus(function(a){g.parent||g.appendTo(c),g.parent.jQ.addClass("hasCursor"),g.selection?g.selection.jQ.removeClass("blur"):g.show(),a.stopPropagation()}).blur(function(a){g.hide().parent.blur(),g.selection&&g.selection.jQ.addClass("blur"),a.stopPropagation()});var i={};b.bind("keydown.mathquill",function(a){i.evt=a,i.happened=!0,i.returnValue=g.parent.keydown(a);if(i.returnValue)return!0;a.stopImmediatePropagation();return!1}).bind("keypress.mathquill",function(a){i.happened?i.happened=!1:i.returnValue=g.parent.keydown(i.evt);if(!i.returnValue)return!1;if(a.ctrlKey||a.metaKey||a.which<32)return!0;if(g.parent.keypress(a))return!0;a.stopImmediatePropagation();return!1}).bind("click.mathquill",function(b){var c=a(b.target);if(c.hasClass("empty")){g.clearSelection().prependTo(c.data("[[mathquill internal data]]").block);return!1}var d=c.data("[[mathquill internal data]]");if(d){if(d.cmd&&!d.block){g.clearSelection(),c.outerWidth()>2*(b.pageX-c.offset().left)?g.insertBefore(d.cmd):g.insertAfter(d.cmd);return!1}}else{c=c.parent(),d=c.data("[[mathquill internal data]]");if(!d)return}g.clearSelection(),d.cmd?g.insertAfter(d.cmd):g.appendTo(d.block);var e,f,h=g.jQ.offset().left-b.pageX;do g.moveLeft(),e=f,f=h,h=Math.abs(g.jQ.offset().left-b.pageX);while(h<=f&&h!=e);h!=e&&g.moveRight();return!1}).bind("click.mathquill",function(){h.focus()}).bind("focus.mathquill blur.mathquill",function(a){h.trigger(a)}).blur()}}function f(b,c,d){arguments.length&&(this.parent=b,this.prev=c||0,this.next=d||0,this.jQinit(this.fold(a(),function(a){return this.jQ.add(a)})))}function e(){}function d(a,b){c.call(this,a,[b])}function c(b,c,d){arguments.length&&(this.cmd=b,c&&(this.html_template=c),this.jQ=a(this.html_template[0]).data("[[mathquill internal data]]",{cmd:this}),this.initBlocks(d))}function b(){}b.prototype={prev:0,next:0,parent:0,firstChild:0,lastChild:0,eachChild:function(a){for(var b=this.firstChild;b;b=b.next)if(a.call(b)===!1)break;return this},foldChildren:function(a,b){this.eachChild(function(){a=b.call(this,a)});return a},keydown:function(a){return this.parent.keydown(a)},keypress:function(a){return this.parent.keypress(a)}},c.prototype=a.extend(new b,{initBlocks:function(b){if(this.html_template.length===1)this.firstChild=this.lastChild=this.jQ.data("[[mathquill internal data]]").block=b&&b.blockify()||new e,this.firstChild.parent=this,this.firstChild.jQ=this.jQ.append(this.firstChild.jQ);else{var c,d,f=this.html_template.length;this.firstChild=c=d=b&&b.blockify()||new e,c.parent=this,c.jQ=a(this.html_template[1]).data("[[mathquill internal data]]",{block:c}).append(c.jQ).appendTo(this.jQ),c.blur();for(var g=2;g<f;g+=1)c=new e,c.parent=this,c.prev=d,d.next=c,d=c,c.jQ=a(this.html_template[g]).data("[[mathquill internal data]]",{block:c}).appendTo(this.jQ),c.blur();this.lastChild=c}},latex:function(){return this.foldChildren(this.cmd,function(a){return a+"{"+(this.latex()||" ")+"}"})},remove:function(){this.prev?this.prev.next=this.next:this.parent.firstChild=this.next,this.next?this.next.prev=this.prev:this.parent.lastChild=this.prev,this.jQ.remove();return this},respace:a.noop,placeCursor:function(a){a.appendTo(this.foldChildren(this.firstChild,function(a){return a.isEmpty()?a:this}))},isEmpty:function(){return this.foldChildren(!0,function(a){return a&&this.isEmpty()})}}),d.prototype=a.extend(new c,{initBlocks:a.noop,latex:function(){return this.cmd},placeCursor:a.noop,isEmpty:function(){return!0}}),e.prototype=a.extend(new b,{latex:function(){return this.foldChildren("",function(a){return a+this.latex()})},isEmpty:function(){return this.firstChild===0&&this.lastChild===0},focus:function(){this.jQ.addClass("hasCursor"),this.isEmpty()&&this.jQ.removeClass("empty");return this},blur:function(){this.jQ.removeClass("hasCursor"),this.isEmpty()&&this.jQ.addClass("empty");return this}}),f.prototype={remove:c.prototype.remove,jQinit:function(a){this.jQ=a},each:function(a){for(var b=this.prev.next||this.parent.firstChild;b!==this.next;b=b.next)if(a.call(b)===!1)break;return this},fold:function(a,b){this.each(function(){a=b.call(this,a)});return a},blockify:function(){var a=new e;a.firstChild=this.prev.next||this.parent.firstChild,a.lastChild=this.next.prev||this.parent.lastChild,this.prev?this.prev.next=this.next:this.parent.firstChild=this.next,this.next?this.next.prev=this.prev:this.parent.lastChild=this.prev,a.firstChild.prev=this.prev=0,a.lastChild.next=this.next=0,this.parent=a,this.each(function(){this.parent=a}),a.jQ=this.jQ;return a}},h.prototype=a.extend(new e,{latex:function(){return e.prototype.latex.call(this).replace(/(\\[a-z]+) (?![a-z])/ig,"$1")},renderLatex:function(a){a=a.match(/\\[a-z]*|[^\s]/ig),this.jQ.children().slice(1).remove(),this.firstChild=this.lastChild=0,this.cursor.show().appendTo(this),a&&function b(c){while(a.length){var d=a.shift();if(!d||d==="}")return;var e;if(d==="\\text"){var f=a.shift();if(f==="{"){f=d=a.shift();while(d!=="}")d==="\\"&&(f+=d=a.shift()),f+=d=a.shift();f=f.slice(0,-1)}e=new w(f),c.insertNew(e).insertAfter(e);continue}if(d==="\\left"||d==="\\right"){d=a.shift(),d==="\\"&&(d=a.shift()),c.write(d),e=c.prev||c.parent.parent;if(c.prev)return;a.unshift("{")}else if(/^\\[a-z]+$/i.test(d)){d=d.slice(1);var e=l[d];if(e)c.insertNew(e=new e(undefined,d));else{e=new w(d),c.insertNew(e).insertAfter(e);continue}}else d.match(/[a-eg-zA-Z]/)?e=new D(d):(e=l[d])?e=new e:e=new E(d),c.insertNew(e);e.eachChild(function(){c.appendTo(this);var d=a.shift();if(!d)return!1;d==="{"?b(c):c.write(d)}),c.insertAfter(e)}}(this.cursor),this.cursor.hide(),this.blur()},keydown:function(a){this.skipKeypress=!0,a.ctrlKey=a.ctrlKey||a.metaKey;switch(a.originalEvent&&a.originalEvent.keyIdentifier||a.which){case 8:case"Backspace":case"U+0008":if(a.ctrlKey)while(this.cursor.prev)this.cursor.backspace();else this.cursor.backspace();break;case 27:case"Esc":case"U+001B":case 9:case"Tab":case"U+0009":if(a.ctrlKey)break;var b=this.cursor.parent;if(a.shiftKey){if(b===this)break;b.prev?this.cursor.appendTo(b.prev):this.cursor.insertBefore(b.parent)}else{if(b===this)return this.skipKeypress=!0;b.next?this.cursor.prependTo(b.next):this.cursor.insertAfter(b.parent)}this.cursor.clearSelection();return!1;case 13:case"Enter":a.preventDefault();break;case 35:case"End":if(a.shiftKey)while(this.cursor.next||a.ctrlKey&&this.cursor.parent!==this)this.cursor.selectRight();else this.cursor.clearSelection().appendTo(a.ctrlKey?this:this.cursor.parent);break;case 36:case"Home":if(a.shiftKey)while(this.cursor.prev||a.ctrlKey&&this.cursor.parent!==this)this.cursor.selectLeft();else this.cursor.clearSelection().prependTo(a.ctrlKey?this:this.cursor.parent);break;case 37:case"Left":if(a.ctrlKey)break;a.shiftKey?this.cursor.selectLeft():this.cursor.moveLeft();break;case 38:case"Up":if(a.ctrlKey)break;if(a.shiftKey)if(this.cursor.prev)while(this.cursor.prev)this.cursor.selectLeft();else this.cursor.selectLeft();else this.cursor.parent.prev?this.cursor.clearSelection().appendTo(this.cursor.parent.prev):this.cursor.prev?this.cursor.clearSelection().prependTo(this.cursor.parent):this.cursor.parent!==this&&this.cursor.clearSelection().insertBefore(this.cursor.parent.parent);break;case 39:case"Right":if(a.ctrlKey)break;a.shiftKey?this.cursor.selectRight():this.cursor.moveRight();break;case 40:case"Down":if(a.ctrlKey)break;if(a.shiftKey)if(this.cursor.next)while(this.cursor.next)this.cursor.selectRight();else this.cursor.selectRight();else this.cursor.parent.next?this.cursor.clearSelection().prependTo(this.cursor.parent.next):this.cursor.next?this.cursor.clearSelection().appendTo(this.cursor.parent):this.cursor.parent!==this&&this.cursor.clearSelection().insertAfter(this.cursor.parent.parent);break;case 46:case"Del":case"U+007F":if(a.ctrlKey)while(this.cursor.next)this.cursor.deleteForward();else this.cursor.deleteForward();break;case 65:case"A":case"U+0041":if(!a.ctrlKey||a.shiftKey||a.altKey){this.skipKeypress=!1;break}if(this.parent)return this.parent.keydown(a);this.cursor.clearSelection().appendTo(this);while(this.cursor.prev)this.cursor.selectLeft();break;default:this.skipKeypress=!1}return!0},keypress:function(a){if(this.skipKeypress)return!0;this.cursor.show().write(String.fromCharCode(a.which)),a.preventDefault();return!0}}),i.prototype=a.extend(new c,{html_template:['<span class="mathquill-rendered-math"></span>'],initBlocks:function(){this.firstChild=this.lastChild=this.jQ.data("[[mathquill internal data]]").block=new h,this.firstChild.parent=this,this.firstChild.jQ=this.jQ}}),j.prototype=a.extend(new e,{renderLatex:function(a){this.jQ.children().slice(1).remove(),this.firstChild=this.lastChild=0,this.cursor.show().appendTo(this);var b,c,d;while(a){b=c="",d=a.indexOf("$"),d<0?(c=a,a=""):(c=a.slice(0,d),a=a.slice(d+1));for(var e=0;e<c.length;e+=1)this.cursor.insertNew(new E(c.charAt(e)));d=a.indexOf("$"),d<0?(b=a,a=""):(b=a.slice(0,d),a=a.slice(d+1));if(b){var f=new i(this.cursor);this.cursor.insertNew(f),f.firstChild.renderLatex(b),this.cursor.show().insertAfter(f)}}},keydown:h.prototype.keydown,keypress:function(a){if(this.skipKeypress)return!0;this.cursor.deleteSelection();var b=String.fromCharCode(a.which);b==="$"?this.cursor.insertNew(new i(this.cursor)):this.cursor.insertNew(new E(b)),a.preventDefault();return!0}});var k={},l={};n.prototype=new c,n.prototype.latex=function(){var a=this.firstChild.latex();return a.length===1?this.cmd+a:this.cmd+"{"+(a||" ")+"}"},n.prototype.redraw=function(){this.respace(),this.next&&this.next.respace(),this.prev&&this.prev.respace()},n.prototype.respace=function(){this.prev&&(this.prev.cmd==="\\int "||this.prev instanceof n&&this.prev.cmd!=this.cmd&&this.prev.prev&&this.prev.prev.cmd==="\\int ")?this.limit||(this.limit=!0,this.jQ.addClass("limit")):this.limit&&(this.limit=!1,this.jQ.removeClass("limit")),(this.respaced=this.prev instanceof n&&this.prev.cmd!=this.cmd&&!this.prev.respaced)?this.limit&&this.cmd==="_"?this.jQ.css({left:-.25-this.prev.jQ.outerWidth()/+this.jQ.css("fontSize").slice(0,-2)+"em",marginRight:.1-Math.min(this.jQ.outerWidth(),this.prev.jQ.outerWidth())/+this.jQ.css("fontSize").slice(0,-2)+"em"}):this.jQ.css({left:-this.prev.jQ.outerWidth()/+this.jQ.css("fontSize").slice(0,-2)+"em",marginRight:.1-Math.min(this.jQ.outerWidth(),this.prev.jQ.outerWidth())/+this.jQ.css("fontSize").slice(0,-2)+"em"}):this.limit&&this.cmd==="_"?this.jQ.css({left:"-.25em",marginRight:""}):this.cmd==="^"&&this.next&&this.next.cmd==="\\sqrt"?this.jQ.css({left:"",marginRight:Math.max(-.3,.1-this.jQ.outerWidth()/+this.jQ.css("fontSize").slice(0,-2))+"em"}).addClass("limit"):this.jQ.css({left:"",marginRight:""});return this},l.subscript=l._=m(n,function(a){n.call(this,"_","<sub></sub>",a)}),l.superscript=l.supscript=l["^"]=m(n,function(a){n.call(this,"^","<sup></sup>",a)}),o.prototype=new c,o.prototype.html_template=['<span class="fraction"></span>','<span class="numerator"></span>','<span class="denominator"></span>'],l.frac=l.fraction=o,p.prototype=new o,p.prototype.placeCursor=function(a){if(this.firstChild.isEmpty()){var b=this.prev;while(b&&!(b instanceof G||b instanceof w||b instanceof I))b=b.prev;b instanceof I&&b.next instanceof n&&(b=b.next,b.next instanceof n&&b.next.cmd!=b.cmd&&(b=b.next));if(b!==this.prev){var c=(new f(this.parent,b,this)).blockify();c.jQ=this.firstChild.jQ.empty().removeClass("empty").append(c.jQ).data("[[mathquill internal data]]",{block:c}),c.next=this.lastChild,c.parent=this,this.firstChild=this.lastChild.prev=c}}a.appendTo(this.lastChild)},k["/"]=p,q.prototype=new c,q.prototype.html_template=['<span><span class="sqrt-prefix">&radic;</span></span>','<span class="sqrt-stem"></span>'],q.prototype.redraw=function(){var a=this.firstChild.jQ,b=a.outerHeight(!0);a.css({borderTopWidth:b/28+1}).prev().css({fontSize:.9*b/+a.css("fontSize").slice(0,-2)+"em"})},l.sqrt=q,r.prototype=new c,r.prototype.initBlocks=function(a){this.firstChild=this.lastChild=a&&a.blockify()||new e,this.firstChild.parent=this,this.firstChild.jQ=this.jQ.children(":eq(1)").data("[[mathquill internal data]]",{block:this.firstChild}).append(this.firstChild.jQ)},r.prototype.latex=function(){return this.cmd+this.firstChild.latex()+this.end},r.prototype.redraw=function(){var a=this.firstChild.jQ;a.prev().add(a.next()).css("fontSize",a.outerHeight()/(+a.css("fontSize").slice(0,-2)*1.02)+"em")},l.lbrace=k["{"]=m(r,function(a){r.call(this,"{","}","\\{","\\}",a)}),l.langle=l.lang=m(r,function(a){r.call(this,"&lang;","&rang;","\\langle ","\\rangle ",a)}),s.prototype=new r,s.prototype.placeCursor=function(a){!this.next&&this.parent.parent&&this.parent.parent.end===this.end&&this.firstChild.isEmpty()?a.backspace().insertAfter(this.parent.parent):this.firstChild.blur()},l.rbrace=k["}"]=m(s,function(a){s.call(this,"{","}","\\{","\\}",a)}),l.rangle=l.rang=m(s,function(a){s.call(this,"&lang;","&rang;","\\langle ","\\rangle ",a)}),t.prototype=r.prototype,l.lparen=k["("]=m(t,function(a){t.call(this,"(",")",a)}),l.lbrack=l.lbracket=k["["]=m(t,function(a){t.call(this,"[","]",a)}),u.prototype=s.prototype,l.rparen=k[")"]=m(u,function(a){u.call(this,"(",")",a)}),l.rbrack=l.rbracket=k["]"]=m(u,function(a){u.call(this,"[","]",a)}),v.prototype=new t,v.prototype.placeCursor=function(a){!this.next&&this.parent.parent&&this.parent.parent.end===this.end&&this.firstChild.isEmpty()?a.backspace().insertAfter(this.parent.parent):a.appendTo(this.firstChild)},l.lpipe=l.rpipe=k["|"]=v,w.prototype=a.extend(new c,{html_template:['<span class="text"></span>'],initBlocks:function(){this.firstChild=this.lastChild=this.jQ.data("[[mathquill internal data]]").block=new x,this.firstChild.parent=this,this.firstChild.jQ=this.jQ.append(this.firstChild.jQ)},placeCursor:function(a){(this.cursor=a).appendTo(this.firstChild);if(this.replacedText)for(var b=0;b<this.replacedText.length;b+=1)this.write(this.replacedText.charAt(b))},write:function(a){this.cursor.insertNew(new E(a))},keydown:function(a){if(!this.cursor.selection&&(a.which===8&&!this.cursor.prev||a.which===46&&!this.cursor.next)){this.isEmpty()&&this.cursor.insertAfter(this);return!1}return this.parent.keydown(a)},keypress:function(a){this.cursor.deleteSelection();var b=String.fromCharCode(a.which);if(b!=="$")this.write(b);else if(this.isEmpty())this.cursor.insertAfter(this).backspace().insertNew(new E("\\$","$"));else if(this.cursor.next)if(this.cursor.prev){var c=new w(new f(this.firstChild,this.cursor.prev));c.placeCursor=function(a){this.prev=0,delete this.placeCursor,this.placeCursor(a)},c.firstChild.focus=function(){return this},this.cursor.insertAfter(this).insertNew(c),c.prev=this,this.cursor.insertBefore(c),delete c.firstChild.focus}else this.cursor.insertBefore(this);else this.cursor.insertAfter(this);return!1}}),x.prototype=a.extend(new e,{blur:function(){this.jQ.removeClass("hasCursor");if(this.isEmpty()){var a=this.parent,b=a.cursor;b.parent===this?this.jQ.addClass("empty"):(b.hide(),a.remove(),b.next===a?b.next=a.next:b.prev===a&&(b.prev=a.prev),b.show().redraw())}return this},focus:function(){e.prototype.focus.call(this);var a=this.parent;if(a.next instanceof w){var b=this,c=a.cursor,d=a.next.firstChild;d.eachChild(function(){this.parent=b,this.jQ.appendTo(b.jQ)}),this.lastChild?this.lastChild.next=d.firstChild:this.firstChild=d.firstChild,d.firstChild.prev=this.lastChild,this.lastChild=d.lastChild,d.parent.remove(),c.prev?c.insertAfter(c.prev):c.prependTo(this),c.redraw()}else if(a.prev instanceof w){var c=a.cursor;c.prev?a.prev.firstChild.focus():c.appendTo(a.prev.firstChild)}return this}}),l.text=k.$=w,y.prototype=a.extend(new c,{html_template:['<span class="latex-command-input"></span>'],placeCursor:function(a){this.cursor=a.appendTo(this.firstChild),this.replacedFragment&&(this.jQ=this.jQ.add(this.replacedFragment.jQ.addClass("blur").insertBefore(this.jQ)))},latex:function(){return"\\"+this.firstChild.latex()+" "},keydown:function(a){if(a.which===9||a.which===13){this.renderCommand();return!1}return this.parent.keydown(a)},keypress:function(a){var b=String.fromCharCode(a.which);if(b.match(/[a-z]/i)){this.cursor.deleteSelection(),this.cursor.insertNew(new E(b));return!1}this.renderCommand();if(b===" "||b==="\\"&&this.firstChild.isEmpty())return!1;return this.cursor.parent.keypress(a)},renderCommand:function(){this.jQ=this.jQ.last(),this.remove(),this.next?this.cursor.insertBefore(this.next):this.cursor.appendTo(this.parent);var a=this.firstChild.latex(),b;if(a)if(b=l[a])b=new b(this.replacedFragment,a);else{b=new w(a),b.firstChild.focus=function(){delete this.focus;return!0},this.cursor.insertNew(b).insertAfter(b),this.replacedFragment&&this.replacedFragment.remove();return}else b=new E("\\backslash ","\\");this.cursor.insertNew(b),b instanceof d&&this.replacedFragment&&this.replacedFragment.remove()}}),k["\\"]=y,z.prototype=new c,z.prototype.html_template=["<span></span>","<span></span>","<span></span>"],z.prototype.redraw=function(){this.jQ.children(":first").add(this.jQ.children(":last")).css("fontSize",this.jQ.outerHeight()/(+this.jQ.css("fontSize").slice(0,-2)*.9+2)+"em")},l.binom=l.binomial=z,A.prototype=new z,A.prototype.placeCursor=p.prototype.placeCursor,l.choose=A,B.prototype=new c,B.prototype.html_template=['<span class="array"></span>',"<span></span>"],B.prototype.latex=function(){return"\\begin{matrix}"+this.foldChildren([],function(a){a.push(this.latex());return a}).join("\\\\")+"\\end{matrix}"},B.prototype.placeCursor=function(a){this.cursor=a.appendTo(this.firstChild)},B.prototype.keydown=function(b){var c=this.cursor.parent;if(c.parent===this){if(b.which===13){var d=new e;d.parent=this,d.jQ=a("<span></span>").data("[[mathquill internal data]]",{block:d}).insertAfter(c.jQ),c.next?c.next.prev=d:this.lastChild=d,d.next=c.next,c.next=d,d.prev=c,this.cursor.appendTo(d).redraw();return!1}if(b.which===9&&!b.shiftKey&&!c.next){if(c.isEmpty()){if(c.prev){this.cursor.insertAfter(this),delete c.prev.next,this.lastChild=c.prev,c.jQ.remove(),this.cursor.redraw();return!1}return this.parent.keydown(b)}var d=new e;d.parent=this,d.jQ=a("<span></span>").data("[[mathquill internal data]]",{block:d}).appendTo(this.jQ),this.lastChild=d,c.next=d,d.prev=c,this.cursor.appendTo(d).redraw();return!1}if(b.which===8){if(c.isEmpty()){c.prev?(this.cursor.appendTo(c.prev),c.prev.next=c.next):(this.cursor.insertBefore(this),this.firstChild=c.next),c.next?c.next.prev=c.prev:this.lastChild=c.prev,c.jQ.remove(),this.isEmpty()?this.cursor.deleteForward():this.cursor.redraw();return!1}if(!this.cursor.prev)return!1}}return this.parent.keydown(b)},l.vector=B,l.editable=m(i,function(){c.call(this,"\\editable"),g(this.jQ,this.firstChild,!1,!0);var a;this.placeCursor=function(b){a=b.appendTo(this.firstChild)},this.firstChild.blur=function(){a.prev===this.parent&&(delete this.blur,this.cursor.appendTo(this),e.prototype.blur.call(this))}}),l.f=C(d,"f",'<var class="florin">&fnof;</var>'),D.prototype=d.prototype,E.prototype=d.prototype,k[" "]=C(E,"\\:"," "),l.prime=k["'"]=C(E,"'","&prime;"),F.prototype=d.prototype,l["@"]=F,l["&"]=C(F,"\\&","&"),l["%"]=C(F,"\\%","%"),l.alpha=l.beta=l.gamma=l.delta=l.zeta=l.eta=l.theta=l.iota=l.kappa=l.mu=l.nu=l.xi=l.rho=l.sigma=l.tau=l.chi=l.psi=l.omega=m(d,function(a,b){D.call(this,"\\"+b+" ","&"+b+";")}),l.phi=C(D,"\\phi ","&#981;"),l.phiv=l.varphi=C(D,"\\varphi ","&phi;"),l.epsilon=C(D,"\\epsilon ","&#1013;"),l.epsiv=l.varepsilon=C(D,"\\varepsilon ","&epsilon;"),l.sigmaf=l.sigmav=l.varsigma=C(D,"\\varsigma ","&sigmaf;"),l.upsilon=l.upsi=C(D,"\\upsilon ","&upsilon;"),l.gammad=l.Gammad=l.digamma=C(D,"\\digamma ","&#989;"),l.kappav=l.varkappa=C(D,"\\varkappa ","&#1008;"),l.piv=l.varpi=C(D,"\\varpi ","&#982;"),l.rhov=l.varrho=C(D,"\\varrho ","&#1009;"),l.thetav=l.vartheta=C(D,"\\vartheta ","&#977;"),l.pi=C(F,"\\pi ","&pi;"),l.lambda=C(F,"\\lambda ","&lambda;"),l.Upsilon=l.Upsi=C(D,"\\Upsilon ","&Upsilon;"),l.Gamma=l.Delta=l.Theta=l.Lambda=l.Xi=l.Pi=l.Sigma=l.Phi=l.Psi=l.Omega=l.forall=m(d,function(a,b){E.call(this,"\\"+b+" ","&"+b+";")}),G.prototype=new d,H.prototype=new G,H.prototype.respace=function(){this.prev?this.prev instanceof G&&this.next&&!(this.next instanceof G)?this.jQ[0].className="unary-operator":this.jQ[0].className="binary-operator":this.jQ[0].className="";return this},l["+"]=C(H,"+"),l["-"]=C(H,"-","&minus;"),l.pm=l.plusmn=l.plusminus=C(H,"\\pm ","&plusmn;"),l.mp=l.mnplus=l.minusplus=C(H,"\\mp ","&#8723;"),k["*"]=l.sdot=l.cdot=C(G,"\\cdot ","&middot;"),l["="]=C(G,"=","="),l["<"]=C(G,"<","&lt;"),l[">"]=C(G,">","&gt;"),l.notin=l.sim=l.cong=l.equiv=l.times=l.oplus=l.otimes=m(G,function(a,b){G.call(this,"\\"+b+" ","&"+b+";")}),l.div=l.divide=l.divides=C(G,"\\div ","&divide;"),l.ne=l.neq=C(G,"\\ne ","&ne;"),l.ast=l.star=l.loast=l.lowast=C(G,"\\ast ","&lowast;"),l.therefor=l.therefore=C(G,"\\therefore ","&there4;"),l.cuz=l.because=C(G,"\\because ","&#8757;"),l.prop=l.propto=C(G,"\\propto ","&prop;"),l.asymp=l.approx=C(G,"\\approx ","&asymp;"),l.lt=C(G,"<","&lt;"),l.gt=C(G,"<","&gt;"),l.le=l.leq=C(G,"\\le ","&le;"),l.ge=l.geq=C(G,"\\ge ","&ge;"),l.isin=l["in"]=C(G,"\\in ","&isin;"),l.ni=l.contains=C(G,"\\ni ","&ni;"),l.notni=l.niton=l.notcontains=l.doesnotcontain=C(G,"\\not\\ni ","&#8716;"),l.sub=l.subset=C(G,"\\subset ","&sub;"),l.sup=l.supset=l.superset=C(G,"\\supset ","&sup;"),l.nsub=l.notsub=l.nsubset=l.notsubset=C(G,"\\not\\subset ","&#8836;"),l.nsup=l.notsup=l.nsupset=l.notsupset=l.nsuperset=l.notsuperset=C(G,"\\not\\supset ","&#8837;"),l.sube=l.subeq=l.subsete=l.subseteq=C(G,"\\subseteq ","&sube;"),l.supe=l.supeq=l.supsete=l.supseteq=l.supersete=l.superseteq=C(G,"\\supseteq ","&supe;"),l.nsube=l.nsubeq=l.notsube=l.notsubeq=l.nsubsete=l.nsubseteq=l.notsubsete=l.notsubseteq=C(G,"\\not\\subseteq ","&#8840;"),l.nsupe=l.nsupeq=l.notsupe=l.notsupeq=l.nsupsete=l.nsupseteq=l.notsupsete=l.notsupseteq=l.nsupersete=l.nsuperseteq=l.notsupersete=l.notsuperseteq=C(G,"\\not\\supseteq ","&#8841;"),I.prototype=new d,l.sum=l.summation=C(I,"\\sum ","&sum;"),l.prod=l.product=C(I,"\\prod ","&prod;"),l.coprod=l.coproduct=C(I,"\\coprod ","&#8720;"),l.int=l.integral=C(I,"\\int ","&int;"),l.N=l.naturals=l.Naturals=C(E,"\\mathbb{N}","&#8469;"),l.P=l.primes=l.Primes=l.projective=l.Projective=l.probability=l.Probability=C(E,"\\mathbb{P}","&#8473;"),l.Z=l.integers=l.Integers=C(E,"\\mathbb{Z}","&#8484;"),l.Q=l.rationals=l.Rationals=C(E,"\\mathbb{Q}","&#8474;"),l.R=l.reals=l.Reals=C(E,"\\mathbb{R}","&#8477;"),l.C=l.complex=l.Complex=l.complexes=l.Complexes=l.complexplane=l.Complexplane=l.ComplexPlane=C(E,"\\mathbb{C}","&#8450;"),l.H=l.Hamiltonian=l.quaternions=l.Quaternions=C(E,"\\mathbb{H}","&#8461;"),l.quad=l.emsp=C(E,"\\quad ","    "),l.qquad=C(E,"\\qquad ","        "),l.caret=C(E,"\\caret ","^"),l.underscore=C(E,"\\underscore ","_"),l.backslash=C(E,"\\backslash ","\\"),l.vert=C(E,"|"),l.perp=l.perpendicular=C(E,"\\perp ","&perp;"),l.nabla=l.del=C(E,"\\nabla ","&nabla;"),l.hbar=C(E,"\\hbar ","&#8463;"),l.AA=l.Angstrom=l.angstrom=C(E,"\\text\\AA ","&#8491;"),l.ring=l.circ=l.circle=C(E,"\\circ ","&#8728;"),l.bull=l.bullet=C(E,"\\bullet ","&bull;"),l.setminus=l.smallsetminus=C(E,"\\setminus ","&#8726;"),l.not=l.neg=C(E,"\\neg ","&not;"),l.dots=l.ellip=l.hellip=l.ellipsis=l.hellipsis=C(E,"\\dots ","&hellip;"),l.converges=l.darr=l.dnarr=l.dnarrow=l.downarrow=C(E,"\\downarrow ","&darr;"),l.dArr=l.dnArr=l.dnArrow=l.Downarrow=C(E,"\\Downarrow ","&dArr;"),l.diverges=l.uarr=l.uparrow=C(E,"\\uparrow ","&uarr;"),l.uArr=l.Uparrow=C(E,"\\Uparrow ","&uArr;"),l.to=C(G,"\\to ","&rarr;"),l.rarr=l.rightarrow=C(E,"\\rightarrow ","&rarr;"),l.implies=C(G,"\\Rightarrow ","&rArr;"),l.rArr=l.Rightarrow=C(E,"\\Rightarrow ","&rArr;"),l.gets=C(G,"\\gets ","&larr;"),l.larr=l.leftarrow=C(E,"\\leftarrow ","&larr;"),l.impliedby=C(G,"\\Leftarrow ","&lArr;"),l.lArr=l.Leftarrow=C(E,"\\Leftarrow ","&lArr;"),l.harr=l.lrarr=l.leftrightarrow=C(E,"\\leftrightarrow ","&harr;"),l.iff=C(G,"\\Leftrightarrow ","&hArr;"),l.hArr=l.lrArr=l.Leftrightarrow=C(E,"\\Leftrightarrow ","&hArr;"),l.Re=l.Real=l.real=C(E,"\\Re ","&real;"),l.Im=l.imag=l.image=l.imagin=l.imaginary=l.Imaginary=C(E,"\\Im ","&image;"),l.part=l.partial=C(E,"\\partial ","&part;"),l.inf=l.infin=l.infty=l.infinity=C(E,"\\infty ","&infin;"),l.alef=l.alefsym=l.aleph=l.alephsym=C(E,"\\aleph ","&alefsym;"),l.xist=l.xists=l.exist=l.exists=C(E,"\\exists ","&exist;"),l.and=l.land=l.wedge=C(E,"\\wedge ","&and;"),l.or=l.lor=l.vee=C(E,"\\vee ","&or;"),l.o=l.O=l.empty=l.emptyset=l.oslash=l.Oslash=l.nothing=l.varnothing=C(G,"\\varnothing ","&empty;"),l.cup=l.union=C(E,"\\cup ","&cup;"),l.cap=l.intersect=l.intersection=C(E,"\\cap ","&cap;"),l.deg=l.degree=C(E,"^\\circ ","&deg;"),l.ang=l.angle=C(E,"\\angle ","&ang;"),J.prototype=new d,J.prototype.respace=function(){this.jQ[0].className=this.next instanceof n||this.next instanceof r?"":"non-italicized-function"},l.ln=l.lg=l.log=l.span=l.proj=l.det=l.dim=l.min=l.max=l.mod=l.lcm=l.gcd=l.gcf=l.hcf=l.lim=J,function(){var a=["sin","cos","tan","sec","cosec","csc","cotan","cot"];for(var b in a)l[a[b]]=l[a[b]+"h"]=l["a"+a[b]]=l["arc"+a[b]]=l["a"+a[b]+"h"]=l["arc"+a[b]+"h"]=J}(),K.prototype={prev:0,next:0,parent:0,show:function(){this.jQ=this._jQ.removeClass("blink"),"intervalId"in this?clearInterval(this.intervalId):(this.next?this.selection&&this.selection.prev===this.prev?this.jQ.insertBefore(this.selection.jQ):this.jQ.insertBefore(this.next.jQ):this.jQ.appendTo(this.parent.jQ),this.parent.focus()),this.intervalId=setInterval(this.blink,500);return this},hide:function(){"intervalId"in this&&clearInterval(this.intervalId),delete this.intervalId,this.jQ.detach(),this.jQ=a();return this},redraw:function(){for(var a=this.parent;a;a=a.parent)a.redraw&&a.redraw()},insertAt:function(a,b,c){var d=this.parent;this.parent=a,this.next=b,this.prev=c,d.blur()},insertBefore:function(a){this.insertAt(a.parent,a,a.prev),this.parent.jQ.addClass("hasCursor"),this.jQ.insertBefore(a.jQ.first());return this},insertAfter:function(a){this.insertAt(a.parent,a.next,a),this.parent.jQ.addClass("hasCursor"),this.jQ.insertAfter(a.jQ.last());return this},prependTo:function(a){this.insertAt(a,a.firstChild,0),a.textarea?this.jQ.insertAfter(a.textarea):this.jQ.prependTo(a.jQ),a.focus();return this},appendTo:function(a){this.insertAt(a,0,a.lastChild),this.jQ.appendTo(a.jQ),a.focus();return this},hopLeft:function(){this.jQ.insertBefore(this.prev.jQ.first()),this.next=this.prev,this.prev=this.prev.prev;return this},hopRight:function(){this.jQ.insertAfter(this.next.jQ.last()),this.prev=this.next,this.next=this.next.next;return this},moveLeft:function(){this.selection?this.insertBefore(this.selection.prev.next||this.parent.firstChild).clearSelection():this.prev?this.prev.lastChild?this.appendTo(this.prev.lastChild):this.hopLeft():this.parent.prev?this.appendTo(this.parent.prev):this.parent!==this.root&&this.insertBefore(this.parent.parent);return this.show()},moveRight:function(){this.selection?this.insertAfter(this.selection.next.prev||this.parent.lastChild).clearSelection():this.next?this.next.firstChild?this.prependTo(this.next.firstChild):this.hopRight():this.parent.next?this.prependTo(this.parent.next):this.parent!==this.root&&this.insertAfter(this.parent.parent);return this.show()},write:function(a){this.selection&&(this.prev=this.selection.prev,this.next=this.selection.next);var b;a.match(/^[a-eg-zA-Z]$/)?b=new D(a):(b=k[a]||l[a])?b=new b(this.selection,a):b=new E(a),this.selection&&(b instanceof d&&this.selection.remove(),delete this.selection);return this.insertNew(b)},insertNew:function(a){a.parent=this.parent,a.next=this.next,a.prev=this.prev,this.prev?this.prev.next=a:this.parent.firstChild=a,this.next?this.next.prev=a:this.parent.lastChild=a,a.jQ.insertBefore(this.jQ),this.prev=a,a.respace(),this.next&&this.next.respace(),this.prev&&this.prev.respace(),a.placeCursor(this),this.redraw();return this},unwrapGramp:function(){var a=this.parent.parent,b=a.parent,c=a.prev,d=this;a.eachChild(function(){this.isEmpty()||(this.eachChild(function(){this.parent=b,this.jQ.insertBefore(a.jQ)}),this.firstChild.prev=c,c?c.next=this.firstChild:b.firstChild=this.firstChild,c=this.lastChild)}),c.next=a.next,a.next?a.next.prev=c:b.lastChild=c;if(!this.next)if(this.prev)this.next=this.prev.next;else while(!this.next){this.parent=this.parent.next;if(this.parent)this.next=this.parent.firstChild;else{this.next=a.next,this.parent=b;break}}this.next?this.insertBefore(this.next):this.appendTo(b),a.jQ.remove(),a.prev&&a.prev.respace(),a.next&&a.next.respace()},backspace:function(){if(!this.deleteSelection())if(this.prev)this.prev.isEmpty()?this.prev=this.prev.remove().prev:this.selectLeft();else if(this.parent!==this.root){if(this.parent.parent.isEmpty())return this.insertAfter(this.parent.parent).backspace();this.unwrapGramp()}this.prev&&this.prev.respace(),this.next&&this.next.respace(),this.redraw();return this},deleteForward:function(){if(!this.deleteSelection())if(this.next)this.next.isEmpty()?this.next=this.next.remove().next:this.selectRight();else if(this.parent!==this.root){if(this.parent.parent.isEmpty())return this.insertBefore(this.parent.parent).deleteForward();this.unwrapGramp()}this.prev&&this.prev.respace(),this.next&&this.next.respace(),this.redraw();return this},selectLeft:function(){this.selection?this.selection.prev===this.prev?this.prev?(this.hopLeft().next.jQ.prependTo(this.selection.jQ),this.selection.prev=this.prev):this.parent!==this.root&&this.insertBefore(this.parent.parent).selection.levelUp():(this.prev.jQ.insertAfter(this.selection.jQ),this.hopLeft().selection.next=this.next,this.selection.prev===this.prev&&this.deleteSelection()):(this.prev?this.hopLeft():this.parent!==this.root&&this.insertBefore(this.parent.parent),this.hide().selection=new L(this.parent,this.prev,this.next.next))},selectRight:function(){this.selection?this.selection.next===this.next?this.next?(this.hopRight().prev.jQ.appendTo(this.selection.jQ),this.selection.next=this.next):this.parent!==this.root&&this.insertAfter(this.parent.parent).selection.levelUp():(this.next.jQ.insertBefore(this.selection.jQ),this.hopRight().selection.prev=this.prev,this.selection.next===this.next&&this.deleteSelection()):(this.next?this.hopRight():this.parent!==this.root&&this.insertAfter(this.parent.parent),this.hide().selection=new L(this.parent,this.prev.prev,this.next))},clearSelection:function(){this.show().selection&&(this.selection.clear(),delete this.selection);return this},deleteSelection:function(){if(!this.show().selection)return!1;this.prev=this.selection.prev,this.next=this.selection.next,this.selection.remove(),delete this.selection;return!0}},L.prototype=a.extend(new f,{jQinit:function(a){this.jQ=a.wrapAll('<span class="selection"></span>').parent()},levelUp:function(){this.clear().jQinit(this.parent.parent.jQ),this.prev=this.parent.parent.prev,this.next=this.parent.parent.next,this.parent=this.parent.parent.parent;return this},clear:function(){this.jQ.replaceWith(this.jQ.children());return this},blockify:function(){this.jQ.replaceWith(this.jQ=this.jQ.children());return f.prototype.blockify.call(this)},detach:function(){var a=f.prototype.blockify.call(this);this.blockify=function(){this.jQ.replaceWith(a.jQ=this.jQ=this.jQ.children());return a};return this}}),a.fn.mathquill=function(b,c){switch(b){case"redraw":this.find(":not(:has(:first))").mathquill("[[mathquill internal data]]").cmd.redraw();return this;case"revert":return this.each(function(){var b=a(this).data("[[mathquill internal data]]");b&&b.revert&&b.revert()});case"latex":if(arguments.length>1)return this.each(function(){var b=a(this).data("[[mathquill internal data]]");b&&b.block&&b.block.renderLatex&&b.block.renderLatex(c)});var d=this.data("[[mathquill internal data]]");return d&&d.block&&d.block.latex();case"html":return this.html().replace(/<span class="?cursor( blink)?"?><\/span>/i,"").replace(/<span class="?textarea"?><textarea><\/textarea><\/span>/i,"");case"write":c=c.charAt(0)==="\\"?c.slice(1):c;if(arguments.length>1)return this.each(function(){var b=a(this).data("[[mathquill internal data]]"),d=b&&b.block,e=d&&d.cursor;e&&(e.show().write(c),d.blur())});default:var e=b==="textbox",f=e||b==="editable",i=e?j:h;return this.each(function(){g(a(this),new i,e,f)})}},a(function(){a(".mathquill-editable").mathquill("editable"),a(".mathquill-textbox").mathquill("textbox"),a(".mathquill-embedded-latex").mathquill()})})(jQuery)