/**
 * Copyright 2010 Jay and Han (laughinghan@gmail.com)
 * License, Usage and Readme at http://mathquill.com
 */(function(a){function O(a,b,c){i.apply(this,arguments)}function N(b){this.parent=this.root=b;var c=this.jQ=this._jQ=a('<span class="cursor"></span>');this.blink=function(){c.toggleClass("blink")}}function M(a,b){g.call(this,"\\"+b+" ","<span>"+b+"</span>")}function L(a,b){g.call(this,a,"<big>"+b+"</big>")}function K(a,b){H.apply(this,arguments)}function J(a,b,c){g.call(this,a,'<span class="binary-operator">'+b+"</span>",c)}function I(a,b){g.call(this,a,'<span class="nonSymbola">'+(b||a)+"</span>")}function H(a,b){g.call(this,a,"<span>"+(b||a)+"</span>")}function G(a,b){g.call(this,a,"<var>"+(b||a)+"</var>")}function F(a){var b=Array.prototype.slice.call(arguments,1);return p(a,function(){a.apply(this,b)})}function E(a){f.call(this,"\\vector",c,c,a)}function D(){C.apply(this,arguments)}function C(a){f.call(this,"\\binom",c,c,a),this.jQ.wrapInner('<span class="array"></span>').prepend('<span class="paren">(</span>').append('<span class="paren">)</span>')}function B(a){f.call(this,"\\"),a&&(this.replacedFragment=a.detach(),this.isEmpty=function(){return!1})}function A(){}function z(a){a instanceof i?this.replacedText=a.remove().jQ.text():typeof a=="string"&&(this.replacedText=a),f.call(this,"\\text")}function y(a){w.call(this,"|","|",a)}function x(a,b,c){v.call(this,a,b,a,b,c)}function w(a,b,c){u.call(this,a,b,a,b,c)}function v(a,b,c,d,e){u.apply(this,arguments)}function u(a,b,c,d,e){f.call(this,"\\left"+c,['<span><span class="paren">'+a+'</span><span></span><span class="paren">'+b+"</span></span>"],[a,b],e),this.end="\\right"+d}function t(a){f.call(this,"\\sqrt",c,c,a)}function s(){r.apply(this,arguments)}function r(a){f.call(this,"\\frac",c,c,a),this.jQ.append('<span style="width:0">&nbsp;</span>')}function q(a,b,c,d){f.call(this,a,[b],[c],d)}function p(a,b){b.prototype=a.prototype;return b}function m(){}function l(a){f.call(this,"$"),this.firstChild.cursor=a,this.firstChild.textInput=function(b){this.skipTextInput||(b!=="$"||a.parent!==this?a.write(b):this.isEmpty()?a.insertAfter(this.parent).backspace().insertNew(new H("\\$","$")).show():a.next?a.prev?a.write(b):a.insertBefore(this.parent):a.insertAfter(this.parent))}}function k(){}function j(b,e,f,g){function o(d){p=c,i.blink=q,i.selection||i.show(),b.unbind("mousemove",m),a(document).unbind("mousemove",n).unbind("mouseup",o)}function n(a){delete a.target;return m(a)}function m(b){i.seek(a(b.target),b.pageX,b.pageY),i.prev===p.prev&&i.parent===p.parent?i.clearSelection():i.selectFrom(p);return!1}function k(){var a=j.val();!a||(j.val(""),i.parent.textInput(a))}var h=b.contents().detach();f||b.addClass("mathquill-rendered-math"),e.jQ=b.data(d,{block:e,revert:function(){b.empty().unbind(".mathquill").removeClass("mathquill-rendered-math mathquill-editable mathquill-textbox").append(h)}});var i=e.cursor=new N(e);e.renderLatex(h.text());if(!!g){e.textarea=a('<span class="textarea"><textarea></textarea></span>').prependTo(b.addClass("mathquill-editable"));var j=e.textarea.children();f&&b.addClass("mathquill-textbox"),j.focus(function(a){i.parent||i.appendTo(e),i.parent.jQ.addClass("hasCursor"),i.selection?i.selection.jQ.removeClass("blur"):i.show(),a.stopPropagation()}).blur(function(a){i.hide().parent.blur(),i.selection&&i.selection.jQ.addClass("blur"),a.stopPropagation()});var l={};b.bind("focus.mathquill blur.mathquill",function(a){j.trigger(a)}).bind("keydown.mathquill",function(a){l.evt=a,l.happened=!0,l.returnValue=i.parent.keydown(a);if(l.returnValue)return!0;a.stopImmediatePropagation();return!1}).bind("keypress.mathquill",function(a){l.happened?l.happened=!1:l.returnValue=i.parent.keydown(l.evt);if(!l.returnValue)return!1;setTimeout(k)}).bind("mousedown.mathquill",function(c){i.seek(a(c.target),c.pageX,c.pageY).blink=a.noop,p=new N(e),p.jQ=p._jQ=a(),i.next?p.insertBefore(i.next):p.appendTo(i.parent),b.mousemove(m),a(document).mousemove(n).mouseup(o),setTimeout(function(){j.focus()})}).bind("selectstart.mathquill",!1).blur();var p,q=i.blink}}function i(b,c,d){if(!!arguments.length){var e=this;e.parent=b,e.prev=c||0,e.next=d||0,e.jQinit(e.fold(a(),function(a,b){return b.jQ.add(a)}))}}function h(){}function g(a,b,c){f.call(this,a,[b],[c||(a&&a.length>1?a.slice(1):a)])}function f(b,c,e,f){if(!!arguments.length){var g=this;g.cmd=b,c&&(g.html_template=c),e&&(g.text_template=e),g.jQ=a(g.html_template[0]).data(d,{cmd:g}),g.initBlocks(f)}}function e(){}var b,c,d="[[mathquill internal data]]";b=e.prototype,b.prev=0,b.next=0,b.parent=0,b.firstChild=0,b.lastChild=0,b.eachChild=function(a){for(var b=this.firstChild;b;b=b.next)if(a.call(this,b)===!1)break;return this},b.foldChildren=function(a,b){this.eachChild(function(c){a=b.call(this,a,c)});return a},b.keydown=function(a){return this.parent.keydown(a)},b.textInput=function(a){return this.parent.textInput(a)},b=f.prototype=new e,b.initBlocks=function(b){var c=this;if(c.html_template.length===1)c.firstChild=c.lastChild=c.jQ.data(d).block=b&&b.blockify()||new h,c.firstChild.parent=c,c.firstChild.jQ=c.jQ.append(c.firstChild.jQ);else{var e,f,g=c.html_template.length;this.firstChild=e=f=b&&b.blockify()||new h,e.parent=c,e.jQ=a(c.html_template[1]).data(d,{block:e}).append(e.jQ).appendTo(c.jQ),e.blur();for(var i=2;i<g;i+=1)e=new h,e.parent=c,e.prev=f,f.next=e,f=e,e.jQ=a(c.html_template[i]).data(d,{block:e}).appendTo(c.jQ),e.blur();c.lastChild=e}},b.latex=function(){return this.foldChildren(this.cmd,function(a,b){return a+"{"+(b.latex()||" ")+"}"})},b.text=function(){var a=0;return this.foldChildren(this.text_template[a],function(b,c){a+=1;var d=c.text();if(b&&this.text_template[a]==="("&&d[0]==="("&&d.slice(-1)===")")return b+d.slice(1,-1)+this.text_template[a];return b+c.text()+(this.text_template[a]||"")})},b.remove=function(){var a=this,b=a.prev,c=a.next,d=a.parent;b?b.next=c:d.firstChild=c,c?c.prev=b:d.lastChild=b,a.jQ.remove();return a},b.respace=a.noop,b.placeCursor=function(a){a.appendTo(this.foldChildren(this.firstChild,function(a,b){return a.isEmpty()?a:b}))},b.isEmpty=function(){return this.foldChildren(!0,function(a,b){return a&&b.isEmpty()})},b=g.prototype=new f,b.initBlocks=a.noop,b.latex=function(){return this.cmd},b.text=function(){return this.text_template},b.placeCursor=a.noop,b.isEmpty=function(){return!0},b=h.prototype=new e,b.latex=function(){return this.foldChildren("",function(a,b){return a+b.latex()})},b.text=function(){return this.firstChild===this.lastChild?this.firstChild.text():this.foldChildren("(",function(a,b){return a+b.text()})+")"},b.isEmpty=function(){return this.firstChild===0&&this.lastChild===0},b.focus=function(){this.jQ.addClass("hasCursor"),this.isEmpty()&&this.jQ.removeClass("empty");return this},b.blur=function(){this.jQ.removeClass("hasCursor"),this.isEmpty()&&this.jQ.addClass("empty");return this},b=i.prototype,b.remove=f.prototype.remove,b.jQinit=function(a){this.jQ=a},b.each=function(a){for(var b=this.prev.next||this.parent.firstChild;b!==this.next;b=b.next)if(a.call(this,b)===!1)break;return this},b.fold=function(a,b){this.each(function(c){a=b.call(this,a,c)});return a},b.latex=function(){return this.fold("",function(a,b){return a+b.latex()})},b.blockify=function(){var a=this,b=a.prev,c=a.next,d=a.parent,e=new h,f=e.firstChild=b.next||d.firstChild,g=e.lastChild=c.prev||d.lastChild;b?b.next=c:d.firstChild=c,c?c.prev=b:d.lastChild=b,f.prev=a.prev=0,g.next=a.next=0,a.parent=e,a.each(function(a){a.parent=e}),e.jQ=a.jQ;return e},b=k.prototype=new h,b.latex=function(){return h.prototype.latex.call(this).replace(/(\\[a-z]+) (?![a-z])/ig,"$1")},b.text=function(){return this.foldChildren("",function(a,b){return a+b.text()})},b.renderLatex=function(a){this.jQ.children().slice(1).remove(),this.firstChild=this.lastChild=0,this.cursor.appendTo(this).writeLatex(a),this.blur()},b.keydown=function(a){this.skipTextInput=!0,a.ctrlKey=a.ctrlKey||a.metaKey;switch(a.originalEvent&&a.originalEvent.keyIdentifier||a.which){case 8:case"Backspace":case"U+0008":if(a.ctrlKey)while(this.cursor.prev||this.cursor.selection)this.cursor.backspace();else this.cursor.backspace();break;case 27:case"Esc":case"U+001B":case 9:case"Tab":case"U+0009":if(a.ctrlKey)break;var b=this.cursor.parent;if(a.shiftKey){if(b===this)break;b.prev?this.cursor.appendTo(b.prev):this.cursor.insertBefore(b.parent)}else{if(b===this)return this.skipTextInput=!0;b.next?this.cursor.prependTo(b.next):this.cursor.insertAfter(b.parent)}this.cursor.clearSelection();return!1;case 13:case"Enter":a.preventDefault();break;case 35:case"End":if(a.shiftKey)while(this.cursor.next||a.ctrlKey&&this.cursor.parent!==this)this.cursor.selectRight();else this.cursor.clearSelection().appendTo(a.ctrlKey?this:this.cursor.parent);break;case 36:case"Home":if(a.shiftKey)while(this.cursor.prev||a.ctrlKey&&this.cursor.parent!==this)this.cursor.selectLeft();else this.cursor.clearSelection().prependTo(a.ctrlKey?this:this.cursor.parent);break;case 37:case"Left":if(a.ctrlKey)break;a.shiftKey?this.cursor.selectLeft():this.cursor.moveLeft();break;case 38:case"Up":if(a.ctrlKey)break;if(a.shiftKey)if(this.cursor.prev)while(this.cursor.prev)this.cursor.selectLeft();else this.cursor.selectLeft();else this.cursor.parent.prev?this.cursor.clearSelection().appendTo(this.cursor.parent.prev):this.cursor.prev?this.cursor.clearSelection().prependTo(this.cursor.parent):this.cursor.parent!==this&&this.cursor.clearSelection().insertBefore(this.cursor.parent.parent);break;case 39:case"Right":if(a.ctrlKey)break;a.shiftKey?this.cursor.selectRight():this.cursor.moveRight();break;case 40:case"Down":if(a.ctrlKey)break;if(a.shiftKey)if(this.cursor.next)while(this.cursor.next)this.cursor.selectRight();else this.cursor.selectRight();else this.cursor.parent.next?this.cursor.clearSelection().prependTo(this.cursor.parent.next):this.cursor.next?this.cursor.clearSelection().appendTo(this.cursor.parent):this.cursor.parent!==this&&this.cursor.clearSelection().insertAfter(this.cursor.parent.parent);break;case 46:case"Del":case"U+007F":if(a.ctrlKey)while(this.cursor.next||this.cursor.selection)this.cursor.deleteForward();else this.cursor.deleteForward();break;case 65:case"A":case"U+0041":if(a.ctrlKey&&!a.shiftKey&&!a.altKey){if(this!==this.cursor.root)return this.parent.keydown(a);this.cursor.clearSelection().appendTo(this);while(this.cursor.prev)this.cursor.selectLeft();a.preventDefault()}else this.skipTextInput=!1;break;case 67:case"C":case"U+0043":if(a.ctrlKey&&!a.shiftKey&&!a.altKey){if(this!==this.cursor.root)return this.parent.keydown(a);if(!this.cursor.selection)return!0;window["MathQuill LaTeX Clipboard"]=this.cursor.selection.latex(),a.preventDefault()}else this.skipTextInput=!1;break;case 86:case"V":case"U+0056":if(a.ctrlKey&&!a.shiftKey&&!a.altKey){if(this!==this.cursor.root)return this.parent.keydown(a);this.cursor.writeLatex(window["MathQuill LaTeX Clipboard"]).show(),a.preventDefault()}else this.skipTextInput=!1;break;case 88:case"X":case"U+0058":if(a.ctrlKey&&!a.shiftKey&&!a.altKey){if(this!==this.cursor.root)return this.parent.keydown(a);if(!this.cursor.selection)return!0;window["MathQuill LaTeX Clipboard"]=this.cursor.selection.latex(),this.cursor.deleteSelection(),a.preventDefault()}else this.skipTextInput=!1;break;default:this.skipTextInput=!1}return!0},b.textInput=function(a){this.skipTextInput||this.cursor.write(a)},b=l.prototype=new f,b.html_template=['<span class="mathquill-rendered-math"></span>'],b.initBlocks=function(){this.firstChild=this.lastChild=this.jQ.data(d).block=new k,this.firstChild.parent=this,this.firstChild.jQ=this.jQ},b=m.prototype=new h,b.renderLatex=function(a){var b=this,c=b.cursor;b.jQ.children().slice(1).remove(),b.firstChild=b.lastChild=0,c.show().appendTo(b),a=a.match(/(?:\\\$|[^$])+|\$(?:\\\$|[^$])*\$|\$(?:\\\$|[^$])*$/g)||"";for(var d=0;d<a.length;d+=1){var e=a[d];if(e[0]==="$"){e[-1+e.length]==="$"&&e[-2+e.length]!=="\\"?e=e.slice(1,-1):e=e.slice(1);var f=new l(c);c.insertNew(f),f.firstChild.renderLatex(e),c.show().insertAfter(f)}else for(var g=0;g<e.length;g+=1)this.cursor.insertNew(new H(e[g]))}},b.keydown=k.prototype.keydown,b.textInput=function(a){this.skipTextInput||(this.cursor.deleteSelection(),a==="$"?this.cursor.insertNew(new l(this.cursor)):this.cursor.insertNew(new H(a)))};var n={},o={};b=q.prototype=new f,b.latex=function(){var a=this.firstChild.latex();return a.length===1?this.cmd+a:this.cmd+"{"+(a||" ")+"}"},b.redraw=function(){this.respace(),this.next&&this.next.respace(),this.prev&&this.prev.respace()},b.respace=function(){this.prev&&(this.prev.cmd==="\\int "||this.prev instanceof q&&this.prev.cmd!=this.cmd&&this.prev.prev&&this.prev.prev.cmd==="\\int ")?this.limit||(this.limit=!0,this.jQ.addClass("limit")):this.limit&&(this.limit=!1,this.jQ.removeClass("limit")),(this.respaced=this.prev instanceof q&&this.prev.cmd!=this.cmd&&!this.prev.respaced)?this.limit&&this.cmd==="_"?this.jQ.css({left:-0.25-this.prev.jQ.outerWidth()/+this.jQ.css("fontSize").slice(0,-2)+"em",marginRight:.1-Math.min(this.jQ.outerWidth(),this.prev.jQ.outerWidth())/+this.jQ.css("fontSize").slice(0,-2)+"em"}):this.jQ.css({left:-this.prev.jQ.outerWidth()/+this.jQ.css("fontSize").slice(0,-2)+"em",marginRight:.1-Math.min(this.jQ.outerWidth(),this.prev.jQ.outerWidth())/+this.jQ.css("fontSize").slice(0,-2)+"em"}):this.limit&&this.cmd==="_"?this.jQ.css({left:"-.25em",marginRight:""}):this.cmd==="^"&&this.next&&this.next.cmd==="\\sqrt"?this.jQ.css({left:"",marginRight:"-.7em"}).addClass("limit"):this.jQ.css({left:"",marginRight:""});return this},o.subscript=o._=p(q,function(a){q.call(this,"_","<sub></sub>","_",a)}),o.superscript=o.supscript=o["^"]=p(q,function(a){q.call(this,"^","<sup></sup>","**",a)}),b=r.prototype=new f,b.html_template=['<span class="fraction"></span>','<span class="numerator"></span>','<span class="denominator"></span>'],b.text_template=["(","/",")"],o.frac=o.fraction=r,b=s.prototype=new r,b.placeCursor=function(a){if(this.firstChild.isEmpty()){var b=this.prev;while(b&&!(b instanceof J||b instanceof z||b instanceof L))b=b.prev;b instanceof L&&b.next instanceof q&&(b=b.next,b.next instanceof q&&b.next.cmd!=b.cmd&&(b=b.next));if(b!==this.prev){var c=(new i(this.parent,b,this)).blockify();c.jQ=this.firstChild.jQ.empty().removeClass("empty").append(c.jQ).data(d,{block:c}),c.next=this.lastChild,c.parent=this,this.firstChild=this.lastChild.prev=c}}a.appendTo(this.lastChild)},n["/"]=s,b=t.prototype=new f,b.html_template=['<span><span class="sqrt-prefix">&radic;</span></span>','<span class="sqrt-stem"></span>'],b.text_template=["sqrt(",")"],b.redraw=function(){var a=this.firstChild.jQ,b=a.outerHeight(!0);a.css({borderTopWidth:b/28+1}).prev().css({fontSize:.9*b/+a.css("fontSize").slice(0,-2)+"em"})},o.sqrt=t,b=u.prototype=new f,b.initBlocks=function(a){this.firstChild=this.lastChild=a&&a.blockify()||new h,this.firstChild.parent=this,this.firstChild.jQ=this.jQ.children(":eq(1)").data(d,{block:this.firstChild}).append(this.firstChild.jQ)},b.latex=function(){return this.cmd+this.firstChild.latex()+this.end},b.redraw=function(){var a=this.firstChild.jQ;a.prev().add(a.next()).css("fontSize",a.outerHeight()/(+a.css("fontSize").slice(0,-2)*1.02)+"em")},o.lbrace=n["{"]=p(u,function(a){u.call(this,"{","}","\\{","\\}",a)}),o.langle=o.lang=p(u,function(a){u.call(this,"&lang;","&rang;","\\langle ","\\rangle ",a)}),b=v.prototype=new u,b.placeCursor=function(a){!this.next&&this.parent.parent&&this.parent.parent.end===this.end&&this.firstChild.isEmpty()?a.backspace().insertAfter(this.parent.parent):this.firstChild.blur()},o.rbrace=n["}"]=p(v,function(a){v.call(this,"{","}","\\{","\\}",a)}),o.rangle=o.rang=p(v,function(a){v.call(this,"&lang;","&rang;","\\langle ","\\rangle ",a)}),w.prototype=u.prototype,o.lparen=n["("]=p(w,function(a){w.call(this,"(",")",a)}),o.lbrack=o.lbracket=n["["]=p(w,function(a){w.call(this,"[","]",a)}),x.prototype=v.prototype,o.rparen=n[")"]=p(x,function(a){x.call(this,"(",")",a)}),o.rbrack=o.rbracket=n["]"]=p(x,function(a){x.call(this,"[","]",a)}),b=y.prototype=new w,b.placeCursor=function(a){!this.next&&this.parent.parent&&this.parent.parent.end===this.end&&this.firstChild.isEmpty()?a.backspace().insertAfter(this.parent.parent):a.appendTo(this.firstChild)},o.lpipe=o.rpipe=n["|"]=y,b=z.prototype=new f,b.html_template=['<span class="text"></span>'],b.text_template=['"','"'],b.initBlocks=function(){this.firstChild=this.lastChild=this.jQ.data(d).block=new A,this.firstChild.parent=this,this.firstChild.jQ=this.jQ.append(this.firstChild.jQ)},b.placeCursor=function(a){(this.cursor=a).appendTo(this.firstChild);if(this.replacedText)for(var b=0;b<this.replacedText.length;b+=1)this.write(this.replacedText.charAt(b))},b.write=function(a){this.cursor.insertNew(new H(a))},b.keydown=function(a){if(!this.cursor.selection&&(a.which===8&&!this.cursor.prev||a.which===46&&!this.cursor.next)){this.isEmpty()&&this.cursor.insertAfter(this);return!1}return this.parent.keydown(a)},b.textInput=function(a){this.cursor.deleteSelection();if(a!=="$")this.write(a);else if(this.isEmpty())this.cursor.insertAfter(this).backspace().insertNew(new H("\\$","$"));else if(!this.cursor.next)this.cursor.insertAfter(this);else if(!this.cursor.prev)this.cursor.insertBefore(this);else{var b=new z(new i(this.firstChild,this.cursor.prev));b.placeCursor=function(a){this.prev=0,delete this.placeCursor,this.placeCursor(a)},b.firstChild.focus=function(){return this},this.cursor.insertAfter(this).insertNew(b),b.prev=this,this.cursor.insertBefore(b),delete b.firstChild.focus}},b=A.prototype=new h,b.blur=function(){this.jQ.removeClass("hasCursor");if(this.isEmpty()){var a=this.parent,b=a.cursor;b.parent===this?this.jQ.addClass("empty"):(b.hide(),a.remove(),b.next===a?b.next=a.next:b.prev===a&&(b.prev=a.prev),b.show().redraw())}return this},b.focus=function(){h.prototype.focus.call(this);var a=this.parent;if(a.next instanceof z){var b=this,c=a.cursor,d=a.next.firstChild;d.eachChild(function(a){a.parent=b,a.jQ.appendTo(b.jQ)}),this.lastChild?this.lastChild.next=d.firstChild:this.firstChild=d.firstChild,d.firstChild.prev=this.lastChild,this.lastChild=d.lastChild,d.parent.remove(),c.prev?c.insertAfter(c.prev):c.prependTo(this),c.redraw()}else if(a.prev instanceof z){var c=a.cursor;c.prev?a.prev.firstChild.focus():c.appendTo(a.prev.firstChild)}return this},o.text=n.$=z,b=B.prototype=new f,b.html_template=['<span class="latex-command-input"></span>'],b.text_template=["\\"],b.placeCursor=function(b){this.cursor=b.appendTo(this.firstChild),this.replacedFragment&&(this.jQ=this.jQ.add(this.replacedFragment.jQ.addClass("blur").bind("mousedown mousemove",function(b){a(b.target=this.nextSibling).trigger(b);return!1}).insertBefore(this.jQ)))},b.latex=function(){return"\\"+this.firstChild.latex()+" "},b.keydown=function(a){if(a.which===9||a.which===13){this.renderCommand();return!1}return this.parent.keydown(a)},b.textInput=function(a){if(a.match(/[a-z]/i))this.cursor.deleteSelection(),this.cursor.insertNew(new H(a));else{this.renderCommand();if(a===" "||a==="\\"&&this.firstChild.isEmpty())return;this.cursor.parent.textInput(a)}},b.renderCommand=function(){this.jQ=this.jQ.last(),this.remove(),this.next?this.cursor.insertBefore(this.next):this.cursor.appendTo(this.parent);var a=this.firstChild.latex(),b;if(a)if(b=o[a])b=new b(this.replacedFragment,a);else{b=new z(a),b.firstChild.focus=function(){delete this.focus;return this},this.cursor.insertNew(b).insertAfter(b),this.replacedFragment&&this.replacedFragment.remove();return}else b=new H("\\backslash ","\\");this.cursor.insertNew(b),b instanceof g&&this.replacedFragment&&this.replacedFragment.remove()},n["\\"]=B,b=C.prototype=new f,b.html_template=["<span></span>","<span></span>","<span></span>"],b.text_template=["choose(",",",")"],b.redraw=function(){this.jQ.children(":first").add(this.jQ.children(":last")).css("fontSize",this.jQ.outerHeight()/(+this.jQ.css("fontSize").slice(0,-2)*.9+2)+"em")},o.binom=o.binomial=C,b=D.prototype=new C,b.placeCursor=s.prototype.placeCursor,o.choose=D,b=E.prototype=new f,b.html_template=['<span class="array"></span>',"<span></span>"],b.latex=function(){return"\\begin{matrix}"+this.foldChildren([],function(a,b){a.push(b.latex());return a}).join("\\\\")+"\\end{matrix}"},b.text=function(){return"["+this.foldChildren([],function(a,b){text.push(b.text());return text}).join()+"]"},b.placeCursor=function(a){this.cursor=a.appendTo(this.firstChild)},b.keydown=function(b){var c=this.cursor.parent;if(c.parent===this){if(b.which===13){var e=new h;e.parent=this,e.jQ=a("<span></span>").data(d,{block:e}).insertAfter(c.jQ),c.next?c.next.prev=e:this.lastChild=e,e.next=c.next,c.next=e,e.prev=c,this.cursor.appendTo(e).redraw();return!1}if(b.which===9&&!b.shiftKey&&!c.next){if(c.isEmpty()){if(c.prev){this.cursor.insertAfter(this),delete c.prev.next,this.lastChild=c.prev,c.jQ.remove(),this.cursor.redraw();return!1}return this.parent.keydown(b)}var e=new h;e.parent=this,e.jQ=a("<span></span>").data(d,{block:e}).appendTo(this.jQ),this.lastChild=e,c.next=e,e.prev=c,this.cursor.appendTo(e).redraw();return!1}if(b.which===8){if(c.isEmpty()){c.prev?(this.cursor.appendTo(c.prev),c.prev.next=c.next):(this.cursor.insertBefore(this),this.firstChild=c.next),c.next?c.next.prev=c.prev:this.lastChild=c.prev,c.jQ.remove(),this.isEmpty()?this.cursor.deleteForward():this.cursor.redraw();return!1}if(!this.cursor.prev)return!1}}return this.parent.keydown(b)},o.vector=E,o.editable=p(l,function(){f.call(this,"\\editable"),j(this.jQ,this.firstChild,!1,!0);var a;this.placeCursor=function(b){a=b.appendTo(this.firstChild)},this.firstChild.blur=function(){a.prev===this.parent&&(delete this.blur,this.cursor.appendTo(this),h.prototype.blur.call(this))},this.text=function(){return this.firstChild.text()}}),o.f=F(g,"f",'<var class="florin">&fnof;</var>'),b=G.prototype=new g,b.text=function(){var a=this.cmd;this.prev&&!(this.prev instanceof G)&&!(this.prev instanceof J)&&(a="*"+a),this.next&&!(this.next instanceof J)&&this.next.cmd!=="^"&&(a+="*");return a},H.prototype=g.prototype,n[" "]=F(H,"\\:"," "),o.prime=n["'"]=F(H,"'","&prime;"),I.prototype=g.prototype,o["@"]=I,o["&"]=F(I,"\\&","&"),o["%"]=F(I,"\\%","%"),o.alpha=o.beta=o.gamma=o.delta=o.zeta=o.eta=o.theta=o.iota=o.kappa=o.mu=o.nu=o.xi=o.rho=o.sigma=o.tau=o.chi=o.psi=o.omega=p(g,function(a,b){G.call(this,"\\"+b+" ","&"+b+";")}),o.phi=F(G,"\\phi ","&#981;"),o.phiv=o.varphi=F(G,"\\varphi ","&phi;"),o.epsilon=F(G,"\\epsilon ","&#1013;"),o.epsiv=o.varepsilon=F(G,"\\varepsilon ","&epsilon;"),o.sigmaf=o.sigmav=o.varsigma=F(G,"\\varsigma ","&sigmaf;"),o.upsilon=o.upsi=F(G,"\\upsilon ","&upsilon;"),o.gammad=o.Gammad=o.digamma=F(G,"\\digamma ","&#989;"),o.kappav=o.varkappa=F(G,"\\varkappa ","&#1008;"),o.piv=o.varpi=F(G,"\\varpi ","&#982;"),o.rhov=o.varrho=F(G,"\\varrho ","&#1009;"),o.thetav=o.vartheta=F(G,"\\vartheta ","&#977;"),o.pi=F(I,"\\pi ","&pi;"),o.lambda=F(I,"\\lambda ","&lambda;"),o.Upsilon=o.Upsi=F(G,"\\Upsilon ","&Upsilon;"),o.Gamma=o.Delta=o.Theta=o.Lambda=o.Xi=o.Pi=o.Sigma=o.Phi=o.Psi=o.Omega=o.forall=p(g,function(a,b){H.call(this,"\\"+b+" ","&"+b+";")}),J.prototype=new g,b=K.prototype=new J,b.respace=function(){this.prev?this.prev instanceof J&&this.next&&!(this.next instanceof J)?this.jQ[0].className="unary-operator":this.jQ[0].className="binary-operator":this.jQ[0].className="";return this},o["+"]=F(K,"+"),o["-"]=F(K,"-","&minus;"),o.pm=o.plusmn=o.plusminus=F(K,"\\pm ","&plusmn;"),o.mp=o.mnplus=o.minusplus=F(K,"\\mp ","&#8723;"),n["*"]=o.sdot=o.cdot=F(J,"\\cdot ","&middot;"),o["="]=F(J,"=","="),o["<"]=F(J,"<","&lt;"),o[">"]=F(J,">","&gt;"),o.notin=o.sim=o.cong=o.equiv=o.oplus=o.otimes=p(J,function(a,b){J.call(this,"\\"+b+" ","&"+b+";")}),o.times=p(J,function(a,b){J.call(this,"\\times ","&times;","[x]")}),o.div=o.divide=o.divides=F(J,"\\div ","&divide;","[/]"),o.ne=o.neq=F(J,"\\ne ","&ne;"),o.ast=o.star=o.loast=o.lowast=F(J,"\\ast ","&lowast;"),o.therefor=o.therefore=F(J,"\\therefore ","&there4;"),o.cuz=o.because=F(J,"\\because ","&#8757;"),o.prop=o.propto=F(J,"\\propto ","&prop;"),o.asymp=o.approx=F(J,"\\approx ","&asymp;"),o.lt=F(J,"<","&lt;"),o.gt=F(J,"<","&gt;"),o.le=o.leq=F(J,"\\le ","&le;"),o.ge=o.geq=F(J,"\\ge ","&ge;"),o.isin=o["in"]=F(J,"\\in ","&isin;"),o.ni=o.contains=F(J,"\\ni ","&ni;"),o.notni=o.niton=o.notcontains=o.doesnotcontain=F(J,"\\not\\ni ","&#8716;"),o.sub=o.subset=F(J,"\\subset ","&sub;"),o.sup=o.supset=o.superset=F(J,"\\supset ","&sup;"),o.nsub=o.notsub=o.nsubset=o.notsubset=F(J,"\\not\\subset ","&#8836;"),o.nsup=o.notsup=o.nsupset=o.notsupset=o.nsuperset=o.notsuperset=F(J,"\\not\\supset ","&#8837;"),o.sube=o.subeq=o.subsete=o.subseteq=F(J,"\\subseteq ","&sube;"),o.supe=o.supeq=o.supsete=o.supseteq=o.supersete=o.superseteq=F(J,"\\supseteq ","&supe;"),o.nsube=o.nsubeq=o.notsube=o.notsubeq=o.nsubsete=o.nsubseteq=o.notsubsete=o.notsubseteq=F(J,"\\not\\subseteq ","&#8840;"),o.nsupe=o.nsupeq=o.notsupe=o.notsupeq=o.nsupsete=o.nsupseteq=o.notsupsete=o.notsupseteq=o.nsupersete=o.nsuperseteq=o.notsupersete=o.notsuperseteq=F(J,"\\not\\supseteq ","&#8841;"),L.prototype=new g,o.sum=o.summation=F(L,"\\sum ","&sum;"),o.prod=o.product=F(L,"\\prod ","&prod;"),o.coprod=o.coproduct=F(L,"\\coprod ","&#8720;"),o.int=o.integral=F(L,"\\int ","&int;"),o.N=o.naturals=o.Naturals=F(H,"\\mathbb{N}","&#8469;"),o.P=o.primes=o.Primes=o.projective=o.Projective=o.probability=o.Probability=F(H,"\\mathbb{P}","&#8473;"),o.Z=o.integers=o.Integers=F(H,"\\mathbb{Z}","&#8484;"),o.Q=o.rationals=o.Rationals=F(H,"\\mathbb{Q}","&#8474;"),o.R=o.reals=o.Reals=F(H,"\\mathbb{R}","&#8477;"),o.C=o.complex=o.Complex=o.complexes=o.Complexes=o.complexplane=o.Complexplane=o.ComplexPlane=F(H,"\\mathbb{C}","&#8450;"),o.H=o.Hamiltonian=o.quaternions=o.Quaternions=F(H,"\\mathbb{H}","&#8461;"),o.quad=o.emsp=F(H,"\\quad ","    "),o.qquad=F(H,"\\qquad ","        "),o.diamond=F(H,"\\diamond","&#9671;"),o.bigtriangleup=F(H,"\\bigtriangleup","&#9651;"),o.ominus=F(H,"\\ominus","&#8854;"),o.uplus=F(H,"\\uplus","&#8846;"),o.bigtriangledown=F(H,"\\bigtriangledown","&#9661;"),o.sqcap=F(H,"\\sqcap","&#8851;"),o.triangleleft=F(H,"\\triangleleft","&#8882;"),o.sqcup=F(H,"\\sqcup","&#8852;"),o.triangleright=F(H,"\\triangleright","&#8883;"),o.odot=F(H,"\\odot","&#8857;"),o.bigcirc=F(H,"\\bigcirc","&#9711;"),o.dagger=F(H,"\\dagger","&#0134;"),o.ddagger=F(H,"\\ddagger","&#135;"),o.wr=F(H,"\\wr","&#8768;"),o.amalg=F(H,"\\amalg","&#8720;"),o.models=F(H,"\\models","&#8872;"),o.prec=F(H,"\\prec","&#8826;"),o.succ=F(H,"\\succ","&#8827;"),o.preceq=F(H,"\\preceq","&#8828;"),o.succeq=F(H,"\\succeq","&#8829;"),o.simeq=F(H,"\\simeq","&#8771;"),o.mid=F(H,"\\mid","&#8739;"),o.ll=F(H,"\\ll","&#8810;"),o.gg=F(H,"\\gg","&#8811;"),o.parallel=F(H,"\\parallel","&#8741;"),o.bowtie=F(H,"\\bowtie","&#8904;"),o.sqsubset=F(H,"\\sqsubset","&#8847;"),o.sqsupset=F(H,"\\sqsupset","&#8848;"),o.smile=F(H,"\\smile","&#8995;"),o.sqsubseteq=F(H,"\\sqsubseteq","&#8849;"),o.sqsupseteq=F(H,"\\sqsupseteq","&#8850;"),o.doteq=F(H,"\\doteq","&#8784;"),o.frown=F(H,"\\frown","&#8994;"),o.vdash=F(H,"\\vdash","&#8870;"),o.dashv=F(H,"\\dashv","&#8867;"),o.longleftarrow=F(H,"\\longleftarrow","&#8592;"),o.longrightarrow=F(H,"\\longrightarrow","&#8594;"),o.Longleftarrow=F(H,"\\Longleftarrow","&#8656;"),o.Longrightarrow=F(H,"\\Longrightarrow","&#8658;"),o.longleftrightarrow=F(H,"\\longleftrightarrow","&#8596;"),o.updownarrow=F(H,"\\updownarrow","&#8597;"),o.Longleftrightarrow=F(H,"\\Longleftrightarrow","&#8660;"),o.Updownarrow=F(H,"\\Updownarrow","&#8661;"),o.mapsto=F(H,"\\mapsto","&#8614;"),o.nearrow=F(H,"\\nearrow","&#8599;"),o.hookleftarrow=F(H,"\\hookleftarrow","&#8617;"),o.hookrightarrow=F(H,"\\hookrightarrow","&#8618;"),o.searrow=F(H,"\\searrow","&#8600;"),o.leftharpoonup=F(H,"\\leftharpoonup","&#8636;"),o.rightharpoonup=F(H,"\\rightharpoonup","&#8640;"),o.swarrow=F(H,"\\swarrow","&#8601;"),o.leftharpoondown=F(H,"\\leftharpoondown","&#8637;"),o.rightharpoondown=F(H,"\\rightharpoondown","&#8641;"),o.nwarrow=F(H,"\\nwarrow","&#8598;"),o.ldots=F(H,"\\ldots","&#8230;"),o.cdots=F(H,"\\cdots","&#8943;"),o.vdots=F(H,"\\vdots","&#8942;"),o.ddots=F(H,"\\ddots","&#8944;"),o.surd=F(H,"\\surd","&#8730;"),o.triangle=F(H,"\\triangle","&#9653;"),o.ell=F(H,"\\ell","&#8467;"),o.top=F(H,"\\top","&#8868;"),o.flat=F(H,"\\flat","&#9837;"),o.natural=F(H,"\\natural","&#9838;"),o.sharp=F(H,"\\sharp","&#9839;"),o.wp=F(H,"\\wp","&#8472;"),o.bot=F(H,"\\bot","&#8869;"),o.clubsuit=F(H,"\\clubsuit","&#9827;"),o.diamondsuit=F(H,"\\diamondsuit","&#9826;"),o.heartsuit=F(H,"\\heartsuit","&#9825;"),o.spadesuit=F(H,"\\spadesuit","&#9824;"),o.oint=F(H,"\\oint","&#8750;"),o.bigcap=F(H,"\\bigcap","&#8745;"),o.bigcup=F(H,"\\bigcup","&#8746;"),o.bigsqcup=F(H,"\\bigsqcup","&#8852;"),o.bigvee=F(H,"\\bigvee","&#8744;"),o.bigwedge=F(H,"\\bigwedge","&#8743;"),o.bigodot=F(H,"\\bigodot","&#8857;"),o.bigotimes=F(H,"\\bigotimes","&#8855;"),o.bigoplus=F(H,"\\bigoplus","&#8853;"),o.biguplus=F(H,"\\biguplus","&#8846;"),o.lfloor=F(H,"\\lfloor","&#8970;"),o.rfloor=F(H,"\\rfloor","&#8971;"),o.lceil=F(H,"\\lceil","&#8968;"),o.rceil=F(H,"\\rceil","&#8969;"),o.slash=F(H,"\\slash","&#47;"),o.opencurlybrace=F(H,"\\opencurlybrace","&#123;"),o.closecurlybrace=F(H,"\\closecurlybrace","&#125;"),o.caret=F(H,"\\caret ","^"),o.underscore=F(H,"\\underscore ","_"),o.backslash=F(H,"\\backslash ","\\"),o.vert=F(H,"|"),o.perp=o.perpendicular=F(H,"\\perp ","&perp;"),o.nabla=o.del=F(H,"\\nabla ","&nabla;"),o.hbar=F(H,"\\hbar ","&#8463;"),o.AA=o.Angstrom=o.angstrom=F(H,"\\text\\AA ","&#8491;"),o.ring=o.circ=o.circle=F(H,"\\circ ","&#8728;"),o.bull=o.bullet=F(H,"\\bullet ","&bull;"),o.setminus=o.smallsetminus=F(H,"\\setminus ","&#8726;"),o.not=o.neg=F(H,"\\neg ","&not;"),o.dots=o.ellip=o.hellip=o.ellipsis=o.hellipsis=F(H,"\\dots ","&hellip;"),o.converges=o.darr=o.dnarr=o.dnarrow=o.downarrow=F(H,"\\downarrow ","&darr;"),o.dArr=o.dnArr=o.dnArrow=o.Downarrow=F(H,"\\Downarrow ","&dArr;"),o.diverges=o.uarr=o.uparrow=F(H,"\\uparrow ","&uarr;"),o.uArr=o.Uparrow=F(H,"\\Uparrow ","&uArr;"),o.to=F(J,"\\to ","&rarr;"),o.rarr=o.rightarrow=F(H,"\\rightarrow ","&rarr;"),o.implies=F(J,"\\Rightarrow ","&rArr;"),o.rArr=o.Rightarrow=F(H,"\\Rightarrow ","&rArr;"),o.gets=F(J,"\\gets ","&larr;"),o.larr=o.leftarrow=F(H,"\\leftarrow ","&larr;"),o.impliedby=F(J,"\\Leftarrow ","&lArr;"),o.lArr=o.Leftarrow=F(H,"\\Leftarrow ","&lArr;"),o.harr=o.lrarr=o.leftrightarrow=F(H,"\\leftrightarrow ","&harr;"),o.iff=F(J,"\\Leftrightarrow ","&hArr;"),o.hArr=o.lrArr=o.Leftrightarrow=F(H,"\\Leftrightarrow ","&hArr;"),o.Re=o.Real=o.real=F(H,"\\Re ","&real;"),o.Im=o.imag=o.image=o.imagin=o.imaginary=o.Imaginary=F(H,"\\Im ","&image;"),o.part=o.partial=F(H,"\\partial ","&part;"),o.inf=o.infin=o.infty=o.infinity=F(H,"\\infty ","&infin;"),o.alef=o.alefsym=o.aleph=o.alephsym=F(H,"\\aleph ","&alefsym;"),o.xist=o.xists=o.exist=o.exists=F(H,"\\exists ","&exist;"),o.and=o.land=o.wedge=F(H,"\\wedge ","&and;"),o.or=o.lor=o.vee=F(H,"\\vee ","&or;"),o.o=o.O=o.empty=o.emptyset=o.oslash=o.Oslash=o.nothing=o.varnothing=F(J,"\\varnothing ","&empty;"),o.cup=o.union=F(H,"\\cup ","&cup;"),o.cap=o.intersect=o.intersection=F(H,"\\cap ","&cap;"),o.deg=o.degree=F(H,"^\\circ ","&deg;"),o.ang=o.angle=F(H,"\\angle ","&ang;"),b=M.prototype=new g,b.respace=function(){this.jQ[0].className=this.next instanceof q||this.next instanceof u?"":"non-italicized-function"},o.ln=o.lg=o.log=o.span=o.proj=o.det=o.dim=o.min=o.max=o.mod=o.lcm=o.gcd=o.gcf=o.hcf=o.lim=M,function(){var a=["sin","cos","tan","sec","cosec","csc","cotan","cot"];for(var b in a)o[a[b]]=o[a[b]+"h"]=o["a"+a[b]]=o["arc"+a[b]]=o["a"+a[b]+"h"]=o["arc"+a[b]+"h"]=M}(),b=N.prototype,b.prev=0,b.next=0,b.parent=0,b.show=function(){this.jQ=this._jQ.removeClass("blink"),"intervalId"in this?clearInterval(this.intervalId):(this.next?this.selection&&this.selection.prev===this.prev?this.jQ.insertBefore(this.selection.jQ):this.jQ.insertBefore(this.next.jQ):this.jQ.appendTo(this.parent.jQ),this.parent.focus()),this.intervalId=setInterval(this.blink,500);return this},b.hide=function(){"intervalId"in this&&clearInterval(this.intervalId),delete this.intervalId,this.jQ.detach(),this.jQ=a();return this},b.redraw=function(){for(var a=this.parent;a;a=a.parent)a.redraw&&a.redraw()},b.insertAt=function(a,b,c){var d=this.parent;this.parent=a,this.next=b,this.prev=c,d.blur()},b.insertBefore=function(a){this.insertAt(a.parent,a,a.prev),this.parent.jQ.addClass("hasCursor"),this.jQ.insertBefore(a.jQ.first());return this},b.insertAfter=function(a){this.insertAt(a.parent,a.next,a),this.parent.jQ.addClass("hasCursor"),this.jQ.insertAfter(a.jQ.last());return this},b.prependTo=function(a){this.insertAt(a,a.firstChild,0),a.textarea?this.jQ.insertAfter(a.textarea):this.jQ.prependTo(a.jQ),a.focus();return this},b.appendTo=function(a){this.insertAt(a,0,a.lastChild)
,this.jQ.appendTo(a.jQ),a.focus();return this},b.hopLeft=function(){this.jQ.insertBefore(this.prev.jQ.first()),this.next=this.prev,this.prev=this.prev.prev;return this},b.hopRight=function(){this.jQ.insertAfter(this.next.jQ.last()),this.prev=this.next,this.next=this.next.next;return this},b.moveLeft=function(){this.selection?this.insertBefore(this.selection.prev.next||this.parent.firstChild).clearSelection():this.prev?this.prev.lastChild?this.appendTo(this.prev.lastChild):this.hopLeft():this.parent.prev?this.appendTo(this.parent.prev):this.parent!==this.root&&this.insertBefore(this.parent.parent);return this.show()},b.moveRight=function(){this.selection?this.insertAfter(this.selection.next.prev||this.parent.lastChild).clearSelection():this.next?this.next.firstChild?this.prependTo(this.next.firstChild):this.hopRight():this.parent.next?this.prependTo(this.parent.next):this.parent!==this.root&&this.insertAfter(this.parent.parent);return this.show()},b.seek=function(a,b,c){var e=this;if(a.hasClass("empty")){e.clearSelection().prependTo(a.data(d).block);return e}var f=a.data(d);if(f){if(f.cmd&&!f.block){e.clearSelection(),a.outerWidth()>2*(b-a.offset().left)?e.insertBefore(f.cmd):e.insertAfter(f.cmd);return e}}else a=a.parent(),f=a.data(d),f||(f={block:e.root});e.clearSelection(),f.cmd?e.insertAfter(f.cmd):e.appendTo(f.block);var g=e.jQ.offset().left-b,h;do e.moveLeft(),h=g,g=e.jQ.offset().left-b;while(g>0&&(e.prev||e.parent!==e.root));-g>h&&e.moveRight();return e},b.writeLatex=function(a){this.deleteSelection(),a=a&&a.match(/\\[a-z]*|[^\s]/ig)||0,function b(d){while(a.length){var e=a.shift();if(!e||e==="}")return;var f;if(e==="\\text"){var g=a.shift();if(g==="{"){g="";while((e=a.shift())&&e!=="}")g+=e,e==="\\"&&(g+=e=a.shift())}f=new z(g),d.insertNew(f).insertAfter(f);continue}if(e==="\\left"||e==="\\right"){e=a.shift(),e==="\\"&&(e=a.shift()),d.insertCh(e),f=d.prev||d.parent.parent;if(d.prev)return;a.unshift("{")}else if(/^\\[a-z]+$/i.test(e)){e=e.slice(1);var f=o[e];if(f)d.insertNew(f=new f(c,e));else{f=new z(e),d.insertNew(f).insertAfter(f);continue}}else e.match(/[a-eg-zA-Z]/)?f=new G(e):(f=o[e])?f=new f:f=new H(e),d.insertNew(f);f.eachChild(function(c){d.appendTo(c);var e=a.shift();if(!e)return!1;e==="{"?b(d):d.insertCh(e)}),d.insertAfter(f)}}(this);return this.hide()},b.write=function(a){return this.show().insertCh(a)},b.insertCh=function(a){this.selection&&(this.prev=this.selection.prev,this.next=this.selection.next);var b;a.match(/^[a-eg-zA-Z]$/)?b=new G(a):(b=n[a]||o[a])?b=new b(this.selection,a):b=new H(a),this.selection&&(b instanceof g&&this.selection.remove(),delete this.selection);return this.insertNew(b)},b.insertNew=function(a){a.parent=this.parent,a.next=this.next,a.prev=this.prev,this.prev?this.prev.next=a:this.parent.firstChild=a,this.next?this.next.prev=a:this.parent.lastChild=a,a.jQ.insertBefore(this.jQ),a.respace(),this.next&&this.next.respace(),this.prev&&this.prev.respace(),this.prev=a,a.placeCursor(this),this.redraw();return this},b.unwrapGramp=function(){var a=this.parent.parent,b=a.parent,c=a.prev,d=this;a.eachChild(function(d){d.isEmpty()||(d.eachChild(function(c){c.parent=b,c.jQ.insertBefore(a.jQ)}),d.firstChild.prev=c,c?c.next=d.firstChild:b.firstChild=d.firstChild,c=d.lastChild)}),c.next=a.next,a.next?a.next.prev=c:b.lastChild=c;if(!this.next)if(this.prev)this.next=this.prev.next;else while(!this.next){this.parent=this.parent.next;if(this.parent)this.next=this.parent.firstChild;else{this.next=a.next,this.parent=b;break}}this.next?this.insertBefore(this.next):this.appendTo(b),a.jQ.remove(),a.prev&&a.prev.respace(),a.next&&a.next.respace()},b.backspace=function(){if(!this.deleteSelection())if(this.prev)this.prev.isEmpty()?this.prev=this.prev.remove().prev:this.selectLeft();else if(this.parent!==this.root){if(this.parent.parent.isEmpty())return this.insertAfter(this.parent.parent).backspace();this.unwrapGramp()}this.prev&&this.prev.respace(),this.next&&this.next.respace(),this.redraw();return this},b.deleteForward=function(){if(!this.deleteSelection())if(this.next)this.next.isEmpty()?this.next=this.next.remove().next:this.selectRight();else if(this.parent!==this.root){if(this.parent.parent.isEmpty())return this.insertBefore(this.parent.parent).deleteForward();this.unwrapGramp()}this.prev&&this.prev.respace(),this.next&&this.next.respace(),this.redraw();return this},b.selectFrom=function(a){var b=this,c=a;loopThroughAncestors:for(;;){for(var d=this;d!==b.parent.parent;d=d.parent.parent)if(d.parent===c.parent){f=d,g=c;break loopThroughAncestors}for(var e=a;e!==c.parent.parent;e=e.parent.parent)if(b.parent===e.parent){f=b,g=e;break loopThroughAncestors}b.parent.parent&&(b=b.parent.parent),c.parent.parent&&(c=c.parent.parent)}var f,g,h;if(f.next!==g){for(var i=f;i;i=i.next)if(i===g.prev){h=!0;break}h||(h=g,g=f,f=h)}this.hide().selection=new O(f.parent,f.prev,g.next),this.insertAfter(g.next.prev||g.parent.lastChild)},b.selectLeft=function(){this.selection?this.selection.prev===this.prev?this.prev?(this.hopLeft().next.jQ.prependTo(this.selection.jQ),this.selection.prev=this.prev):this.parent!==this.root&&this.insertBefore(this.parent.parent).selection.levelUp():(this.prev.jQ.insertAfter(this.selection.jQ),this.hopLeft().selection.next=this.next,this.selection.prev===this.prev&&this.deleteSelection()):(this.prev?this.hopLeft():this.parent!==this.root&&this.insertBefore(this.parent.parent),this.hide().selection=new O(this.parent,this.prev,this.next.next))},b.selectRight=function(){this.selection?this.selection.next===this.next?this.next?(this.hopRight().prev.jQ.appendTo(this.selection.jQ),this.selection.next=this.next):this.parent!==this.root&&this.insertAfter(this.parent.parent).selection.levelUp():(this.next.jQ.insertBefore(this.selection.jQ),this.hopRight().selection.prev=this.prev,this.selection.next===this.next&&this.deleteSelection()):(this.next?this.hopRight():this.parent!==this.root&&this.insertAfter(this.parent.parent),this.hide().selection=new O(this.parent,this.prev.prev,this.next))},b.clearSelection=function(){this.show().selection&&(this.selection.clear(),delete this.selection);return this},b.deleteSelection=function(){if(!this.show().selection)return!1;this.prev=this.selection.prev,this.next=this.selection.next,this.selection.remove(),delete this.selection;return!0},b=O.prototype=new i,b.jQinit=function(a){this.jQ=a.wrapAll('<span class="selection"></span>').parent()},b.levelUp=function(){this.clear().jQinit(this.parent.parent.jQ),this.prev=this.parent.parent.prev,this.next=this.parent.parent.next,this.parent=this.parent.parent.parent;return this},b.clear=function(){this.jQ.replaceWith(this.jQ.children());return this},b.blockify=function(){this.jQ.replaceWith(this.jQ=this.jQ.children());return i.prototype.blockify.call(this)},b.detach=function(){var a=i.prototype.blockify.call(this);this.blockify=function(){this.jQ.replaceWith(a.jQ=this.jQ=this.jQ.children());return a};return this},a.fn.mathquill=function(b,c){switch(b){case"redraw":this.find(":not(:has(:first))").data(d).cmd.redraw();return this;case"revert":return this.each(function(){var b=a(this).data(d);b&&b.revert&&b.revert()});case"latex":if(arguments.length>1)return this.each(function(){var b=a(this).data(d);b&&b.block&&b.block.renderLatex&&b.block.renderLatex(c)});var e=this.data(d);return e&&e.block&&e.block.latex();case"text":var e=this.data(d);return e&&e.block&&e.block.text();case"html":return this.html().replace(/<span class="?cursor( blink)?"?><\/span>/i,"").replace(/<span class="?textarea"?><textarea><\/textarea><\/span>/i,"");case"write":if(arguments.length>1)return this.each(function(){var b=a(this).data(d),e=b&&b.block,f=e&&e.cursor;f&&(f.writeLatex(c),e.blur())});default:var f=b==="textbox",g=f||b==="editable",h=f?m:k;return this.each(function(){j(a(this),new h,f,g)})}},a(function(){a(".mathquill-editable").mathquill("editable"),a(".mathquill-textbox").mathquill("textbox"),a(".mathquill-embedded-latex").mathquill()})})(jQuery)